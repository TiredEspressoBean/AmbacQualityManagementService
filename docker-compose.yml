services:
  postgres:
    image: ankane/pgvector:v0.5.1
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-tracker_AMBAC}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-tracker_AMBAC}"]
      interval: 30s
      timeout: 10s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./PartsTracker
      dockerfile: Dockerfile
    restart: unless-stopped
    command: >
      sh -c "
      python manage.py migrate &&
      python manage.py setup_defaults &&
      python manage.py create_temp_admin &&
      python manage.py runserver 0.0.0.0:8000"
    env_file:
      - .env.docker
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=tracker_AMBAC
      - NPM_BIN_PATH=/usr/bin/npm
      - CELERY_BROKER_URL=redis://redis:6379/0
      - REDIS_CACHE_URL=redis://redis:6379/1
      - REDIS_HOST=redis
      - CORS_ALLOW_CREDENTIALS=true
      - CORS_ALLOWED_ORIGINS=https://localhost,https://govtracker.ambac.local,http://localhost,http://govtracker.ambac.local
      - CSRF_TRUSTED_ORIGINS=https://localhost,https://govtracker.ambac.local,http://localhost,http://govtracker.ambac.local
    volumes:
      - ./PartsTracker:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 90s

  celery-worker:
    build:
      context: ./PartsTracker
      dockerfile: Dockerfile
    restart: unless-stopped
    command: celery -A PartsTrackerApp worker --loglevel=info --concurrency=2
    env_file:
      - .env.docker
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=tracker_AMBAC
      - CELERY_BROKER_URL=redis://redis:6379/0
      - REDIS_HOST=redis
    volumes:
      - ./PartsTracker:/app
    # Memory limit for 3D model processing (STEP conversion can use 500MB+ per file)
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    depends_on:
      backend:
        condition: service_healthy
      redis:
        condition: service_healthy

  celery-beat:
    build:
      context: ./PartsTracker
      dockerfile: Dockerfile
    restart: unless-stopped
    command: celery -A PartsTrackerApp beat --loglevel=info
    env_file:
      - .env.docker
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=tracker_AMBAC
      - CELERY_BROKER_URL=redis://redis:6379/0
      - REDIS_HOST=redis
    volumes:
      - ./PartsTracker:/app
    depends_on:
      backend:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Backup service - run with: docker compose --profile backup run --rm backup
  backup:
    image: postgres:15-alpine
    profiles:
      - backup
    volumes:
      - ./backups:/backups
    environment:
      - PGPASSWORD=${POSTGRES_PASSWORD}
    command: >
      sh -c "pg_dump -h postgres -U ${POSTGRES_USER:-postgres} ${POSTGRES_DB:-tracker_AMBAC} | gzip > /backups/db_$$(date +%Y%m%d_%H%M%S).sql.gz && echo 'Backup complete'"
    depends_on:
      - postgres

  # Build MkDocs documentation
  docs-builder:
    image: python:3.12-slim
    profiles:
      - local
      - production
    volumes:
      - ./mkdocs.yml:/docs/mkdocs.yml:ro
      - ./docs:/docs/docs:ro
      - docs-dist:/output
    working_dir: /docs
    command: >
      sh -c "pip install --no-cache-dir mkdocs pymdown-extensions &&
             mkdocs build --site-dir /output"

  # Build frontend for local development
  frontend-builder-local:
    build:
      context: ./ambac-tracker-ui
      dockerfile: Dockerfile
      args:
        - VITE_API_TARGET=
    profiles:
      - local
    environment:
      - VITE_API_TARGET=
    volumes:
      - frontend-dist:/app/dist
    command: ["npm", "run", "build"]

  # Build frontend for production
  frontend-builder:
    build:
      context: ./ambac-tracker-ui
      dockerfile: Dockerfile
      args:
        - VITE_API_TARGET=${VITE_API_TARGET:-https://govtracker.ambac.local}
    profiles:
      - production
    env_file:
      - .env.docker
    volumes:
      - frontend-dist:/app/dist
    command: ["npm", "run", "build"]

  # Caddy for local development (auto self-signed cert)
  caddy-local:
     image: caddy:2-alpine
     restart: unless-stopped
     profiles:
       - local
     ports:
       - "80:80"
       - "443:443"
     extra_hosts:
       - "host.docker.internal:host-gateway"
     volumes:
       - ./conf/Caddyfile.local:/etc/caddy/Caddyfile
       - frontend-dist:/usr/share/caddy
       - docs-dist:/usr/share/caddy/docs
       - caddy_data:/data
       - caddy_config:/config
     depends_on:
       backend:
         condition: service_healthy
       frontend-builder-local:
         condition: service_completed_successfully
       docs-builder:
         condition: service_completed_successfully

  # Caddy for production (custom certs)
  caddy:
     image: caddy:2-alpine
     restart: unless-stopped
     profiles:
       - production
     ports:
       - "80:80"
       - "443:443"
     extra_hosts:
       - "host.docker.internal:host-gateway"
     volumes:
       - ./conf/Caddyfile:/etc/caddy/Caddyfile
       - ./certs:/etc/caddy/certs:ro
       - frontend-dist:/usr/share/caddy
       - docs-dist:/usr/share/caddy/docs
       - caddy_data:/data
       - caddy_config:/config
     depends_on:
       backend:
         condition: service_healthy
       frontend-builder:
         condition: service_completed_successfully
       docs-builder:
         condition: service_completed_successfully

  # Simple nginx for local dev (no SSL/certs needed)
#  nginx-local:
#    image: nginx:alpine
#    restart: unless-stopped
#    ports:
#      - "8080:80"
#    volumes:
#      - frontend-dist:/usr/share/nginx/html
#      - ./nginx-local.conf:/etc/nginx/conf.d/default.conf
#    depends_on:
#      - backend
#      - frontend-builder

networks:
  default:
    name: ambactracker-network
    external: true

volumes:
  postgres_data:
  redis_data:
  frontend-dist:
  docs-dist:
  caddy_data:
  caddy_config: