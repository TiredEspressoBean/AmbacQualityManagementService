# Main site (production)
govtracker.ambac.local {
    tls /etc/caddy/certs/Govtracker.crt /etc/caddy/certs/Govtracker.key


    encode gzip
    
    # Handle API routes first - most specific to least specific
    handle /auth/* {
        reverse_proxy backend:8000
    }
    
    handle /api/* {
        reverse_proxy backend:8000
    }
    
    handle /accounts/* {
        reverse_proxy backend:8000
    }
    
    handle /admin/* {
        reverse_proxy backend:8000
    }
    
    handle /media/* {
        reverse_proxy backend:8000
    }
    
    handle /static/* {
        reverse_proxy backend:8000
    }
    
    # Handle LangGraph API
    handle /lg/* {
        reverse_proxy host.docker.internal:8123 {
            header_up -X-Forwarded-Proto
        }
        header {
            Access-Control-Allow-Origin *
            Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS"
            Access-Control-Allow-Headers "Content-Type,Authorization"
        }
        uri strip_prefix /lg
    }

    # Documentation (MkDocs static files)
    handle /docs/* {
        root * /usr/share/caddy
        file_server
    }

    # Handle SPA routes (fallback)
    handle {
        root * /usr/share/caddy
        try_files {path} /index.html
        file_server
    }
    handle /ai/* {
        reverse_proxy 127.0.0.1:11434
    }
}

